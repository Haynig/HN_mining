<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8" />
  <title>HN Bilimdoni</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Telegram WebApp -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- TON Connect -->
  <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
  <script src="https://unpkg.com/@ton/core@latest/dist/index.umd.js"></script>

  <style>
    body { font-family: Arial, sans-serif; padding: 16px; background:#f6f6f6; }
    h2 { margin-bottom: 10px; }
    button { padding: 10px; margin: 5px 0; font-size: 16px; width:100%; }
    .card { background:#fff; padding:16px; border-radius:10px; margin-bottom:12px; }
    #question { font-size: 18px; margin-bottom:10px; }
    #status { margin-top: 10px; min-height:20px; }
    .small { font-size:14px; color:#555; }
  </style>
</head>
<body>

<h2>üß† HN Bilimdoni</h2>

<div class="card">
  <button onclick="connectWallet()">üîó Wallet ulash</button>
  <button onclick="buyToken()" id="tokenBtn" disabled>üî• Jetton orqali +10 imkon</button>
  <div class="small" id="walletStatus">Wallet ulanmagan</div>
</div>

<div class="card">
  <div id="question">Savol yuklanmoqda...</div>
  <button onclick="sendAnswer(true)">‚úÖ To‚Äòg‚Äòri</button>
  <button onclick="sendAnswer(false)">‚ùå Noto‚Äòg‚Äòri</button>
  <div class="small" id="limits"></div>
</div>

<div id="status"></div>

<script>
// === ASOSIY SOZLAMALAR ===
const BACKEND = "https://hn-bilimdoni-backend.onrender.com";
const tg = window.Telegram.WebApp;

tg.ready();

tg.expand();

const tg_id = tg.initDataUnsafe?.user?.id || 0;

// === TON CONNECT ===
const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
  manifestUrl: "https://raw.githubusercontent.com/Haynig/HN_mining/main/tonconnect-manifest.json"
});

async function connectWallet(){
  await tonConnectUI.openModal();
  if (tonConnectUI.wallet) {
    document.getElementById("tokenBtn").disabled = false;
    document.getElementById("walletStatus").innerText = "Wallet ulandi: " + tonConnectUI.wallet.account.address.slice(0,6) + "...";
    setStatus("‚úÖ Wallet muvaffaqiyatli ulandi");
  }
}

function setStatus(t){ document.getElementById("status").innerText = t; }

// === SAVOL YUKLASH ===
async function loadQuestion(){
  try{
    const res = await fetch(`${BACKEND}/question?tg_id=${tg_id}`);
    const data = await res.json();

    if(data.blocked){
      document.getElementById("question").innerText = "‚õî Bugungi limit tugadi";
      document.getElementById("limits").innerText = data.message;
      return;
    }

    document.getElementById("question").innerText = data.question;
    document.getElementById("limits").innerText = `Bugun: ${data.used}/100 | Xato: ${data.errors}/10`;
  }catch(e){
    setStatus("Backend bilan aloqa yo‚Äòq");
  }
}

// === JAVOB YUBORISH ===
async function sendAnswer(correct){
  const res = await fetch(`${BACKEND}/answer`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify({ tg_id, correct })
  });

  const data = await res.json();
  setStatus(data.message);
  loadQuestion();
}

// === TOKEN SOTIB OLISH ===
async function buyToken(){
  if(!tonConnectUI.wallet){
    setStatus("Avval wallet ulang");
    return;
  }

  setStatus("üî• Jetton tekshirilmoqda...");

  const res = await fetch(`${BACKEND}/buy-token`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify({ tg_id })
  });

  const data = await res.json();
  setStatus(data.message);
  loadQuestion();
}

loadQuestion();
</script>

</body>
</html>
