<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>HN Bilimdoni</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
<script src="https://unpkg.com/@ton/core@latest/dist/index.umd.js"></script>

<style>
  body { font-family: Arial; padding:20px }
  button { padding:10px 15px; margin:5px }
</style>
</head>

<body>

<h2>ğŸ§  HN Bilimdoni</h2>

<div id="wallet">
  <button onclick="connect()">ğŸ”— Wallet ulash</button>
  <button onclick="burn()" id="burnBtn" disabled>ğŸ”¥ 1 jetton ishlatish (+10)</button>
</div>

<hr>

<div id="quiz">
  <h3 id="question"></h3>
  <button onclick="answer(true)">âœ… Toâ€˜gâ€˜ri</button>
  <button onclick="answer(false)">âŒ Notoâ€˜gâ€˜ri</button>
</div>

<hr>

<pre id="log"></pre>

<script>
/* ===== INIT ===== */
const tg = window.Telegram.WebApp;
tg.expand();

const tg_id = tg.initDataUnsafe.user.id;
const API = 'https://YOUR_BACKEND_DOMAIN'; // <-- O'ZGARTIRASAN

const { beginCell, toNano } = tonCore;

/* ===== TON CONNECT ===== */
const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
  manifestUrl: 'https://raw.githubusercontent.com/Haynig/HN_mining/main/tonconnect-manifest1.json'
});

function log(t){
  document.getElementById('log').textContent += t + "\n";
}

/* ===== WALLET ===== */
async function connect(){
  await tonConnectUI.openModal();
  if (tonConnectUI.wallet){
    log("âœ… Wallet ulandi");
    document.getElementById('burnBtn').disabled = false;
  }
}

/* ===== QUESTIONS ===== */
const questions = [
  "2 + 2 = 4 ?",
  "Yer quyosh atrofida aylanadimi?",
  "JavaScript backend tili emasmi?"
];
let qIndex = 0;

function showQuestion(){
  document.getElementById('question').textContent = questions[qIndex];
}
showQuestion();

/* ===== ANSWER CHECK ===== */
async function answer(correct){
  const res = await fetch(API + '/check',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ tg_id, correct })
  });
  const data = await res.json();

  if(!data.ok){
    if(data.reason === 'DAILY_LIMIT')
      alert("âŒ Bugungi 100 ta limit tugadi");
    if(data.reason === 'WRONG_LIMIT')
      alert("âŒ 10 ta xato limiti tugadi");
    return;
  }

  log(correct ? "âœ” Toâ€˜gâ€˜ri" : "âœ– Xato");

  qIndex = (qIndex + 1) % questions.length;
  showQuestion();
}

/* ===== TOKEN BURN ===== */
function burnPayload(){
  return beginCell()
    .storeUint(0x595f07bc, 32)
    .storeUint(0, 64)
    .storeCoins(1n)
    .storeAddress(null)
    .endCell()
    .toBoc()
    .toString('base64');
}

async function burn(){
  const wallet = tonConnectUI.wallet.account.address;

  const tx = {
    validUntil: Math.floor(Date.now()/1000)+300,
    messages: [{
      address: wallet,
      amount: toNano('0.05').toString(),
      payload: burnPayload()
    }]
  };

  const res = await tonConnectUI.sendTransaction(tx);
  log("ğŸ”¥ Token yoqildi");

  await fetch(API + '/use-token',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ tg_id })
  });

  alert("âœ… +10 imkoniyat qoâ€˜shildi");
}
</script>

</body>
</html>
