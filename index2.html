<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8" />
  <title>Quiz + TON Verification</title>

  <!-- Telegram WebApp -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- TON Connect UI -->
  <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    button {
      padding: 12px;
      margin: 6px 0;
      width: 100%;
      font-size: 16px;
    }
    .error {
      color: red;
    }
  </style>
</head>
<body>

<h2>Quiz</h2>

<button onclick="sendAnswer(true)">To‘g‘ri javob</button>
<button onclick="sendAnswer(false)">Xato javob</button>

<p id="status"></p>
<p id="error" class="error"></p>

<hr>

<h3>TON Wallet</h3>
<div id="wallet"></div>

<button onclick="buyTokens()">10 token sotib olish (0.05 TON)</button>

<script>
/* =========================
   Telegram WebApp
========================= */
const tg = window.Telegram.WebApp;
tg.ready();

const userId = tg.initDataUnsafe?.user?.id;
const initData = tg.initData;

if (!userId) {
  alert("Telegram user topilmadi");
}

/* =========================
   Backend URL
========================= */
const API_URL = "http://localhost:3000";

/* =========================
   TON Connect
========================= */
const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
  manifestUrl: "https://raw.githubusercontent.com/Haynig/HN_mining/main/tonconnect-manifest.json"
});

tonConnectUI.render(document.getElementById("wallet"));

/* =========================
   Javob yuborish
========================= */
async function sendAnswer(isCorrect) {
  document.getElementById("error").innerText = "";

  const res = await fetch(API_URL + "/answer", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      userId,
      isCorrect,
      initData
    })
  });

  const data = await res.json();

  if (!res.ok) {
    document.getElementById("error").innerText = data.error;
    return;
  }

  document.getElementById("status").innerText =
    `Savollar qoldi: ${data.dailyLeft}, Xato imkoniyat: ${data.wrongLeft}, Token: ${data.tokens}`;
}

/* =========================
   TON token sotib olish
========================= */
async function buyTokens() {
  if (!tonConnectUI.wallet) {
    alert("Avval wallet ulang");
    return;
  }

  const amountNano = "50000000"; // 0.05 TON

  const tx = {
    validUntil: Math.floor(Date.now() / 1000) + 300,
    messages: [
      {
        address: "UQCkRmK7SA68DL_0wtzynZ7ODmaaUH0zEL4xRQ40PGgQ0snt",
        amount: amountNano
      }
    ]
  };

  try {
    const result = await tonConnectUI.sendTransaction(tx);

    // TON Connect qaytargan transaction hash
    const txHash =
      result?.boc ||
      result?.transactionHash ||
      result?.hash;

    if (!txHash) {
      alert("Transaction hash topilmadi");
      return;
    }

    // Backendga tekshiruv uchun yuboramiz
    const res = await fetch(API_URL + "/verify-payment", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        userId,
        txHash,
        initData
      })
    });

    const data = await res.json();

    if (!res.ok) {
      alert(data.error);
      return;
    }

    alert("To‘lov tasdiqlandi. Token: " + data.tokens);

  } catch (e) {
    alert("To‘lov bekor qilindi");
  }
}
</script>

</body>
</html>
